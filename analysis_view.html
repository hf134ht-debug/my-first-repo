/*************************************************************
 * analysis.gs（v3・spec正規化対応版）
 * AI分析タブ専用 GAS API
*************************************************************/

/* ============================================================
   ▼ 品目正規化
============================================================ */
function aiNormalizeItemName(raw) {
  if (!raw) return '';
  let s = String(raw).trim();
  const lower = s.toLowerCase();

  if (
    /[とうトﾄ][う]?も?ろ?こし/.test(s) ||
    lower.includes('corn') ||
    s.includes('ｺｰﾝ') || s.includes('コーン')
  ) {
    return 'とうもろこし';
  }

  if (s.includes('白菜カット') || s.includes('はくさいカット') || s.includes('ﾊｸｻｲ ｶｯﾄ')) {
    return 'はくさいカット';
  }

  if (s.includes('白菜') || s.includes('はくさい') || s.includes('ﾊｸｻｲ')) {
    return 'はくさい';
  }

  if (s.includes('キャベツカット') || s.includes('ｷｬﾍﾞﾂ ｶｯﾄ')) {
    return 'キャベツカット';
  }

  if (s.includes('キャベツ') || s.includes('ｷｬﾍﾞﾂ')) {
    return 'キャベツ';
  }

  return s;
}

/* ============================================================
   ▼ 規格 spec 正規化（analysis.js と完全一致）
============================================================ */
function normSpec(s) {
  return String(s || "")
    .trim()
    .replace(/\s+/g, "")
    .replace(/〜/g, "~")
    .replace(/－/g, "-")
    .replace(/ー/g, "-");
}

/* ============================================================
   ▼ ① 店舗配分最適化 API
============================================================ */
function apiAllocation(e) {
  const item   = aiNormalizeItemName(e.parameter.item);
  const qty    = Number(e.parameter.qty);
  const price  = Number(e.parameter.price);
  const spec   = normSpec(e.parameter.spec || '');
  const stores = (e.parameter.stores || '').split(',').filter(s => s);

  const sh = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('AI_Allocation');
  if (!sh) return jsonOut([]);

  const values = sh.getDataRange().getValues();
  const header = values.shift();

  const result = [];

  values.forEach(r => {
    const o = rowObj(header, r);

    if (aiNormalizeItemName(o.item) !== item) return;
    if (Number(o.totalQty) !== qty) return;
    if (Number(o.price) !== price) return;
    if (normSpec(o.spec) !== spec) return;
    if (!stores.includes(o.store)) return;

    result.push({
      store: o.store,
      qty: Number(o.storeQty),
      rate: Number(o.rate),
    });
  });

  return jsonOut(result);
}

/* ============================================================
   ▼ ② 逆算 API
============================================================ */
function apiReverse(e) {
  const item   = aiNormalizeItemName(e.parameter.item);
  const target = Number(e.parameter.target);
  const spec   = normSpec(e.parameter.spec || '');

  const sh = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('AI_TargetReverse');
  if (!sh) return jsonOut({});

  const values = sh.getDataRange().getValues();
  const header = values.shift();

  let best = null;

  values.forEach(r => {
    const o = rowObj(header, r);

    if (aiNormalizeItemName(o.item) !== item) return;
    if (Number(o.targetSales) !== target) return;
    if (normSpec(o.spec) !== spec) return;

    if (!best) {
      best = {
        price: Number(o.bestPrice),
        rate: Number(o.rate),
        loss: Number(o.loss),
        alloc: []
      };
    }

    best.alloc.push({
      store: o.store,
      qty: Number(o.qty),
      rate: Number(o.storeRate),
    });
  });

  return jsonOut(best || {});
}

/* ============================================================
   ▼ ③ 価格シミュレーション API
============================================================ */
function apiPriceSim(e) {
  const item  = aiNormalizeItemName(e.parameter.item);
  const price = Number(e.parameter.price);
  const spec  = normSpec(e.parameter.spec || '');

  const sh = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('AI_PriceCurve');
  if (!sh) return jsonOut({});

  const values = sh.getDataRange().getValues();
  const header = values.shift();

  for (let r of values) {
    const o = rowObj(header, r);

    if (aiNormalizeItemName(o.item) !== item) continue;
    if (normSpec(o.spec) !== spec) continue;
    if (Number(o.price) !== price) continue;

    return jsonOut({
      price: price,
      sales: Number(o.sales),
      rate: Number(o.rate),
      loss: Number(o.loss),
      profit: Number(o.profit),
      comment: o.comment || '',
    });
  }

  return jsonOut({});
}

/* ============================================================
   ▼ ④ 需要予測 API
============================================================ */
function apiForecast(e) {
  const item = aiNormalizeItemName(e.parameter.item || '');

  const sh = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('AI_7DaysForecast');
  if (!sh) return jsonOut({});

  const values = sh.getDataRange().getValues();
  const header = values.shift();

  let chart = [0,0,0,0,0,0,0];
  let stores = [];
  let generalComment = '';

  values.forEach(r => {
    const o = rowObj(header, r);

    if (item && aiNormalizeItemName(o.item) !== item) return;

    const di = Number(o.dayIndex);
    if (di >= 0 && di <= 6) chart[di] = Number(o.forecastSales);

    if (o.store)
      stores.push({
        store: o.store,
        star: o.star,
        comment: o.comment
      });

    if (o.generalComment) generalComment = o.generalComment;
  });

  return jsonOut({
    chart,
    stores,
    comment: generalComment
  });
}

/* ============================================================
   ▼ Helper: 行→オブジェクト
============================================================ */
function rowObj(header, arr) {
  const o = {};
  header.forEach((h, i) => o[h] = arr[i]);
  return o;
}

/* ============================================================
   ▼ Helper: JSON出力
============================================================ */
function jsonOut(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
